<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartScan AI | 90% Clarity Lock</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #6366f1; --success: #10b981; --warn: #f59e0b; --bg: #020617; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; overflow: hidden; height: 100vh; }
        
        #viewfinder { position: relative; width: 100%; height: 70vh; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Scanning Overlay */
        .overlay-layer { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #guide-rect { 
            width: 75%; height: 60%; border: 2px solid rgba(255,255,255,0.2); border-radius: 16px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
        }
        #guide-rect.detecting { border-color: var(--warn); box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
        #guide-rect.locked { border-color: var(--success); border-width: 4px; transform: scale(1.02); box-shadow: 0 0 40px rgba(16, 185, 129, 0.5); }

        /* Status & Feedback */
        #ui-panel { width: 100%; padding: 20px; box-sizing: border-box; flex-grow: 1; background: linear-gradient(to top, #020617, #0f172a); border-top: 1px solid rgba(255,255,255,0.1); }
        #status-label { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; display: block; text-align: center; }
        #sub-label { font-size: 0.85rem; opacity: 0.6; display: block; text-align: center; margin-bottom: 15px; }

        .meter-container { width: 100%; height: 8px; background: #1e293b; border-radius: 4px; overflow: hidden; position: relative; }
        #clarity-bar { height: 100%; width: 0%; background: var(--primary); transition: width 0.1s; }
        
        /* Results View */
        #results-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: none; padding: 20px; overflow-y: auto; }
        .data-box { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 15px; font-family: 'Courier New', monospace; white-space: pre-wrap; margin-top: 15px; color: #34d399; line-height: 1.5; }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 12px; font-size: 1rem; }
        .btn-copy { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div id="viewfinder">
    <video id="video" autoplay playsinline></video>
    <div class="overlay-layer">
        <div id="guide-rect"></div>
    </div>
</div>

<div id="ui-panel">
    <span id="status-label">Initializing Lens...</span>
    <span id="sub-label">Position receipt inside the frame</span>
    <div class="meter-container">
        <div id="clarity-bar"></div>
    </div>
</div>

<div id="results-screen">
    <h2 style="margin-top:0">Scan Result</h2>
    <div id="confidence-tag" style="color:var(--success); font-weight:bold;"></div>
    <div id="ocr-data" class="data-box">Processing text...</div>
    <button class="btn btn-copy" onclick="copyResult()">Copy List</button>
    <button class="btn" style="background:#334155; color:white;" onclick="location.reload()">New Scan</button>
</div>

<canvas id="proc-canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const guide = document.getElementById('guide-rect');
    const status = document.getElementById('status-label');
    const sub = document.getElementById('sub-label');
    const bar = document.getElementById('clarity-bar');
    const canvas = document.getElementById('proc-canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    let stream, track;
    let isProcessing = false;
    let clarityHistory = [];
    const REQUIRED_CLARITY = 90; // The target 90% score

    async function init() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: 1920, height: 1080 }
            });
            video.srcObject = stream;
            track = stream.getVideoTracks()[0];
            analyzeLoop();
        } catch (e) {
            status.innerText = "Camera Error";
            sub.innerText = "Please enable camera permissions.";
        }
    }

    function analyzeLoop() {
        if (isProcessing) return;

        canvas.width = 320; 
        canvas.height = 240;
        ctx.drawImage(video, 0, 0, 320, 240);
        
        const pixels = ctx.getImageData(80, 60, 160, 120);
        const clarityScore = calculateClarity(pixels);
        
        // Update Meter
        bar.style.width = clarityScore + "%";
        
        if (clarityScore > 40) { // We see text
            guide.className = "detecting";
            status.innerText = "Text Detected. Holding Focus...";
            sub.innerText = `Clarity: ${Math.round(clarityScore)}% (Goal: 90%)`;
            
            // Auto-Flash if dim
            handleFlash(pixels);

            // Stability check: Is the clarity peaking?
            clarityHistory.push(clarityScore);
            if (clarityHistory.length > 15) clarityHistory.shift();

            const avgClarity = clarityHistory.reduce((a,b) => a+b, 0) / clarityHistory.length;
            
            // Trigger condition: High clarity + Stability
            if (clarityScore >= REQUIRED_CLARITY && clarityScore >= avgClarity) {
                lockAndCapture();
                return;
            }
        } else {
            guide.className = "";
            status.innerText = "Searching for List...";
            sub.innerText = "Move closer to the items";
            clarityHistory = [];
        }

        requestAnimationFrame(analyzeLoop);
    }

    function calculateClarity(imgData) {
        const d = imgData.data;
        let diff = 0;
        // Check vertical contrast (text lines)
        for (let i = 0; i < d.length - 4; i += 4) {
            diff += Math.abs(d[i] - d[i + 4]);
        }
        // Normalize to a 0-100 scale (approximate)
        let score = (diff / (imgData.width * imgData.height)) * 1.8;
        return Math.min(100, score);
    }

    async function handleFlash(imgData) {
        const d = imgData.data;
        let brightness = 0;
        for(let i=0; i<d.length; i+=40) brightness += (d[i]+d[i+1]+d[i+2])/3;
        brightness = brightness / (d.length/40);

        if (track && track.getCapabilities().torch) {
            if (brightness < 50) track.applyConstraints({advanced: [{torch: true}]});
            else if (brightness > 180) track.applyConstraints({advanced: [{torch: false}]});
        }
    }

    function lockAndCapture() {
        isProcessing = true;
        guide.className = "locked";
        status.innerText = "90% Clarity Achieved!";
        sub.innerText = "Focus Locked. Processing...";
        
        // Final Snap
        setTimeout(() => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const image = canvas.toDataURL('image/jpeg', 0.9);
            
            // Kill Camera
            stream.getTracks().forEach(t => t.stop());
            video.style.display = 'none';
            document.getElementById('results-screen').style.display = 'block';
            
            performOCR(image);
        }, 500); // 0.5s pause to ensure focus is perfect
    }

    async function performOCR(dataUrl) {
        const worker = await Tesseract.createWorker('eng');
        const { data: { text, confidence } } = await worker.recognize(dataUrl);
        await worker.terminate();

        document.getElementById('confidence-tag').innerText = `AI Confidence: ${confidence}%`;
        
        // Clean text: Filter for lines that look like products (contain words/numbers)
        const lines = text.split('\n')
            .filter(l => l.trim().length > 3)
            .map((l, i) => `${(i+1).toString().padStart(2,'0')} | ${l.trim()}`)
            .join('\n');

        document.getElementById('ocr-data').innerText = lines || "No items found. Try again.";
    }

    function copyResult() {
        const cleanText = document.getElementById('ocr-data').innerText.replace(/^\d+ \| /gm, '');
        navigator.clipboard.writeText(cleanText);
        alert("List Copied!");
    }

    window.onload = init;
</script>
</body>
</html>
