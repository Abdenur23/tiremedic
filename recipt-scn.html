<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro-Vision Receipt Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --brand: #3b82f6; --bg: #000; --panel: #1e293b; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: white; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* Full-Screen Viewfinder */
        #viewport { position: relative; flex: 1; display: flex; align-items: center; justify-content: center; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* The "Scanner" HUD */
        .hud-overlay { position: absolute; inset: 0; border: 40px solid rgba(0,0,0,0.6); pointer-events: none; display: flex; align-items: center; justify-content: center; }
        #scan-box { 
            width: 85%; height: 75%; border: 2px solid rgba(255,255,255,0.4); border-radius: 12px;
            position: relative; transition: all 0.2s;
        }
        #scan-box.ready { border-color: #10b981; border-width: 4px; box-shadow: 0 0 40px rgba(16, 185, 129, 0.4); }

        /* Real-time Vision Meter */
        #vision-metrics { position: absolute; top: 10px; left: 10px; font-family: monospace; font-size: 10px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px; }

        /* User Feedback Bottom Panel */
        #controls { background: var(--panel); padding: 20px; border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 10; }
        .status-text { font-size: 1.1rem; font-weight: 700; text-align: center; margin-bottom: 8px; display: block; }
        .sub-text { font-size: 0.8rem; opacity: 0.7; text-align: center; display: block; margin-bottom: 15px; }
        
        .progress-container { width: 100%; height: 12px; background: #0f172a; border-radius: 6px; overflow: hidden; }
        #progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #3b82f6, #10b981); transition: width 0.1s; }

        /* Result Overlay */
        #results { position: fixed; inset: 0; background: #0f172a; z-index: 100; display: none; padding: 25px; flex-direction: column; }
        #ocr-text { flex: 1; background: #000; border-radius: 12px; padding: 15px; font-family: 'Courier New', monospace; font-size: 14px; overflow-y: auto; color: #10b981; white-space: pre-wrap; margin: 15px 0; }
        .btn { padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; width: 100%; }
    </style>
</head>
<body>

<div id="viewport">
    <video id="video" autoplay playsinline></video>
    <div id="vision-metrics">SHARP: 0 | ROWS: 0 | STABLE: 0</div>
    <div class="hud-overlay">
        <div id="scan-box"></div>
    </div>
</div>

<div id="controls">
    <span id="status" class="status-text">Detecting Receipt...</span>
    <span id="hint" class="sub-text">Hold your phone steady over the item list</span>
    <div class="progress-container">
        <div id="progress-bar"></div>
    </div>
</div>

<div id="results">
    <h2>Scan Successful</h2>
    <div id="ocr-text">Reading receipt...</div>
    <button class="btn" style="background:#3b82f6; color:white; margin-bottom:10px;" onclick="copyResult()">Copy List</button>
    <button class="btn" style="background:#334155; color:white;" onclick="location.reload()">Scan New</button>
</div>

<canvas id="cv-canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const scanBox = document.getElementById('scan-box');
    const status = document.getElementById('status');
    const bar = document.getElementById('progress-bar');
    const metricsEl = document.getElementById('vision-metrics');
    const cvCanvas = document.getElementById('cv-canvas');
    const cvCtx = cvCanvas.getContext('2d', { willReadFrequently: true });

    let stream, track;
    let stabilityFrames = 0;
    let isProcessing = false;

    async function start() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
            });
            video.srcObject = stream;
            track = stream.getVideoTracks()[0];
            loop();
        } catch (e) { status.innerText = "Camera Access Error"; }
    }

    function loop() {
        if (isProcessing) return;

        // Vision Processing (60fps analysis)
        cvCanvas.width = 200;
        cvCanvas.height = 300;
        cvCtx.drawImage(video, 0, 0, 200, 300);
        
        const imgData = cvCtx.getImageData(25, 50, 150, 200);
        const vision = analyzeVision(imgData);

        // Update Debug HUD
        metricsEl.innerText = `SHARP: ${vision.sharpness} | ROWS: ${vision.rows} | STABLE: ${stabilityFrames}`;

        // RELIABILITY LOGIC: 
        // 1. Must have high sharpness (text is in focus)
        // 2. Must have high row count (it is a list, not a wall)
        // 3. Must be stable (phone isn't moving)
        
        if (vision.sharpness > 20 && vision.rows >= 5) {
            stabilityFrames++;
            scanBox.classList.add('ready');
            status.innerText = "HOLD STEADY...";
            
            let confidence = (stabilityFrames / 20) * 100;
            bar.style.width = confidence + "%";

            if (stabilityFrames >= 20) {
                capture();
                return;
            }
        } else {
            stabilityFrames = Math.max(0, stabilityFrames - 2);
            scanBox.classList.remove('ready');
            status.innerText = vision.rows < 5 ? "Looking for list..." : "Focusing...";
            bar.style.width = "0%";
        }

        requestAnimationFrame(loop);
    }

    function analyzeVision(imgData) {
        const d = imgData.data;
        let sharpness = 0;
        let rows = 0;
        let brightness = 0;

        for (let y = 0; y < imgData.height; y += 2) {
            let rowTransitions = 0;
            for (let x = 0; x < imgData.width * 4; x += 8) {
                const i = (y * imgData.width * 4) + x;
                const lum = (d[i] + d[i+1] + d[i+2]) / 3;
                const nextLum = (d[i+4] || lum);
                const diff = Math.abs(lum - nextLum);
                
                if (diff > 35) {
                    rowTransitions++;
                    sharpness += diff;
                }
                brightness += lum;
            }
            if (rowTransitions > 8) rows++;
        }

        const avgBrightness = brightness / (imgData.width * imgData.height);
        handleTorch(avgBrightness);

        return {
            sharpness: Math.round(sharpness / 1000),
            rows: rows,
            brightness: avgBrightness
        };
    }

    async function handleTorch(lv) {
        if (track && track.getCapabilities().torch) {
            try { track.applyConstraints({advanced: [{torch: lv < 50}]}); } catch(e){}
        }
    }

    function capture() {
        isProcessing = true;
        status.innerText = "CAPTURED!";
        
        // Use high-res for OCR
        cvCanvas.width = video.videoWidth;
        cvCanvas.height = video.videoHeight;
        cvCtx.drawImage(video, 0, 0);
        const dataUrl = cvCanvas.toDataURL('image/jpeg', 0.95);

        // UI Transition
        stream.getTracks().forEach(t => t.stop());
        document.getElementById('results').style.display = 'flex';
        
        runOCR(dataUrl);
    }

    async function runOCR(src) {
        const worker = await Tesseract.createWorker('eng');
        const { data: { text, confidence } } = await worker.recognize(src);
        await worker.terminate();

        const clean = text.split('\n')
            .filter(line => line.length > 5 && /\d/.test(line)) // Must have a number (price/qty)
            .map((line, i) => `${(i+1).toString().padStart(2,'0')} | ${line.trim()}`)
            .join('\n');

        document.getElementById('ocr-text').innerText = clean || "Could not extract a clear list. Try again with better lighting.";
    }

    function copyResult() {
        const t = document.getElementById('ocr-text').innerText.replace(/^\d+ \| /gm, '');
        navigator.clipboard.writeText(t);
        alert("Copied!");
    }

    window.onload = start;
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enterprise Receipt Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --accent: #60a5fa; --bg: #000000; --panel: #111827; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* High-Tech Viewfinder */
        #viewport { position: relative; flex: 1; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Corner Brackets */
        .corner { position: absolute; width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); transition: all 0.2s; }
        .top-left { top: 15%; left: 10%; border-right: 0; border-bottom: 0; }
        .top-right { top: 15%; right: 10%; border-left: 0; border-bottom: 0; }
        .bot-left { bottom: 15%; left: 10%; border-right: 0; border-top: 0; }
        .bot-right { bottom: 15%; right: 10%; border-left: 0; border-top: 0; }
        .active .corner { border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }

        /* Scanning UI */
        #overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #status-card { position: absolute; bottom: 30px; background: var(--panel); padding: 15px 25px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; }
        
        .indicator { width: 12px; height: 12px; border-radius: 50%; background: #374151; transition: background 0.3s; }
        .indicator.on { background: #10b981; box-shadow: 0 0 10px #10b981; }

        /* Progress Bar */
        #confidence-bar { position: absolute; top: 0; left: 0; height: 4px; width: 0%; background: var(--accent); transition: width 0.1s linear; }

        /* Results */
        #results-view { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; padding: 20px; flex-direction: column; }
        .output { flex: 1; background: #0a0a0a; border: 1px solid #262626; border-radius: 8px; padding: 15px; font-family: monospace; overflow-y: auto; color: #d4d4d4; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 15px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

<div id="viewport">
    <video id="video" autoplay playsinline></video>
    <div id="confidence-bar"></div>
    <div id="overlay" class="">
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bot-left"></div>
        <div class="corner bot-right"></div>
        
        <div id="status-card">
            <div id="led" class="indicator"></div>
            <span id="msg">Point at Receipt Items</span>
        </div>
    </div>
</div>

<div id="results-view">
    <h2 style="margin-top:0">Scan Complete</h2>
    <div id="ocr-out" class="output">Extracted list will appear here...</div>
    <div class="btn-row">
        <button style="background:#2563eb; color:white;" onclick="copyOut()">Copy</button>
        <button style="background:#262626; color:white;" onclick="location.reload()">Reset</button>
    </div>
</div>

<canvas id="analysis" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const msg = document.getElementById('msg');
    const led = document.getElementById('led');
    const bar = document.getElementById('confidence-bar');
    const overlay = document.getElementById('overlay');
    const canvas = document.getElementById('analysis');
    const ctx = canvas.getContext('2d', {willReadFrequently: true});

    let stream, track;
    let frameData = [];
    let isCaptured = false;

    async function setup() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: 1280, height: 720, frameRate: { ideal: 30 } }
            });
            video.srcObject = stream;
            track = stream.getVideoTracks()[0];
            process();
        } catch (e) { msg.innerText = "Camera Denied"; }
    }

    function process() {
        if (isCaptured) return;

        canvas.width = 160; 
        canvas.height = 120;
        ctx.drawImage(video, 0, 0, 160, 120);
        
        const pixels = ctx.getImageData(0, 0, 160, 120).data;
        
        // 1. Line Detection (Industry standard for receipts)
        // We look for high-contrast horizontal patterns
        let rowCount = 0;
        for (let y = 10; y < 110; y += 4) {
            let variations = 0;
            for (let x = 20; x < 140; x += 4) {
                const i = (y * 160 + x) * 4;
                const brightness = (pixels[i] + pixels[i+1] + pixels[i+2]) / 3;
                const nextB = (pixels[i+16] + pixels[i+17] + pixels[i+18]) / 3;
                if (Math.abs(brightness - nextB) > 35) variations++;
            }
            if (variations > 4) rowCount++;
        }

        // 2. Temporal Smoothing (Reliability logic)
        // Only trigger if we consistently see the same number of rows for 15 frames
        frameData.push(rowCount);
        if (frameData.length > 15) frameData.shift();
        
        const averageRows = frameData.reduce((a,b) => a+b, 0) / frameData.length;
        const stability = 1 - (Math.abs(rowCount - averageRows) / 10);
        const progress = (rowCount / 12) * stability; // Aiming for 12+ text rows

        // Update UI
        const finalConfidence = Math.min(100, progress * 100);
        bar.style.width = finalConfidence + "%";

        if (rowCount > 5) {
            overlay.className = "active";
            led.className = "indicator on";
            msg.innerText = finalConfidence > 80 ? "STABILIZING..." : "RECEIPT DETECTED";
            
            // Auto-Flash for low light
            toggleFlash(pixels);

            // 3. The Trigger: 90% confidence for ~half a second
            if (finalConfidence > 90) {
                capture();
                return;
            }
        } else {
            overlay.className = "";
            led.className = "indicator";
            msg.innerText = "Align Receipt Items";
        }

        requestAnimationFrame(process);
    }

    function toggleFlash(d) {
        let b = 0;
        for(let i=0; i<d.length; i+=40) b += (d[i]+d[i+1]+d[i+2])/3;
        b = b / (d.length/40);
        if (track && track.getCapabilities().torch) {
            track.applyConstraints({advanced: [{torch: b < 45}]});
        }
    }

    function capture() {
        isCaptured = true;
        msg.innerText = "CAPTURING...";
        
        setTimeout(() => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const blob = canvas.toDataURL('image/jpeg', 0.95);
            
            stream.getTracks().forEach(t => t.stop());
            document.getElementById('results-view').style.display = 'flex';
            runOCR(blob);
        }, 300); // Small delay to let focus settle
    }

    async function runOCR(img) {
        const worker = await Tesseract.createWorker('eng');
        const { data: { text } } = await worker.recognize(img);
        await worker.terminate();

        const lines = text.split('\n')
            .filter(l => l.trim().length > 4)
            .map((l, i) => `<span style="color:#555">${(i+1).toString().padStart(2,'0')}</span>  ${l.trim()}`)
            .join('\n');
            
        document.getElementById('ocr-out').innerHTML = lines || "No text detected. Ensure good lighting.";
    }

    function copyOut() {
        const t = document.getElementById('ocr-out').innerText.replace(/^\d+\s+/gm, '');
        navigator.clipboard.writeText(t);
        alert("List copied!");
    }

    window.onload = setup;
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartScan AI | 90% Clarity Lock</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #6366f1; --success: #10b981; --warn: #f59e0b; --bg: #020617; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; overflow: hidden; height: 100vh; }
        
        #viewfinder { position: relative; width: 100%; height: 70vh; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Scanning Overlay */
        .overlay-layer { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #guide-rect { 
            width: 75%; height: 60%; border: 2px solid rgba(255,255,255,0.2); border-radius: 16px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
        }
        #guide-rect.detecting { border-color: var(--warn); box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
        #guide-rect.locked { border-color: var(--success); border-width: 4px; transform: scale(1.02); box-shadow: 0 0 40px rgba(16, 185, 129, 0.5); }

        /* Status & Feedback */
        #ui-panel { width: 100%; padding: 20px; box-sizing: border-box; flex-grow: 1; background: linear-gradient(to top, #020617, #0f172a); border-top: 1px solid rgba(255,255,255,0.1); }
        #status-label { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; display: block; text-align: center; }
        #sub-label { font-size: 0.85rem; opacity: 0.6; display: block; text-align: center; margin-bottom: 15px; }

        .meter-container { width: 100%; height: 8px; background: #1e293b; border-radius: 4px; overflow: hidden; position: relative; }
        #clarity-bar { height: 100%; width: 0%; background: var(--primary); transition: width 0.1s; }
        
        /* Results View */
        #results-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: none; padding: 20px; overflow-y: auto; }
        .data-box { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 15px; font-family: 'Courier New', monospace; white-space: pre-wrap; margin-top: 15px; color: #34d399; line-height: 1.5; }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-top: 12px; font-size: 1rem; }
        .btn-copy { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div id="viewfinder">
    <video id="video" autoplay playsinline></video>
    <div class="overlay-layer">
        <div id="guide-rect"></div>
    </div>
</div>

<div id="ui-panel">
    <span id="status-label">Initializing Lens...</span>
    <span id="sub-label">Position receipt inside the frame</span>
    <div class="meter-container">
        <div id="clarity-bar"></div>
    </div>
</div>

<div id="results-screen">
    <h2 style="margin-top:0">Scan Result</h2>
    <div id="confidence-tag" style="color:var(--success); font-weight:bold;"></div>
    <div id="ocr-data" class="data-box">Processing text...</div>
    <button class="btn btn-copy" onclick="copyResult()">Copy List</button>
    <button class="btn" style="background:#334155; color:white;" onclick="location.reload()">New Scan</button>
</div>

<canvas id="proc-canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const guide = document.getElementById('guide-rect');
    const status = document.getElementById('status-label');
    const sub = document.getElementById('sub-label');
    const bar = document.getElementById('clarity-bar');
    const canvas = document.getElementById('proc-canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    let stream, track;
    let isProcessing = false;
    let clarityHistory = [];
    const REQUIRED_CLARITY = 90; // The target 90% score

    async function init() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: 1920, height: 1080 }
            });
            video.srcObject = stream;
            track = stream.getVideoTracks()[0];
            analyzeLoop();
        } catch (e) {
            status.innerText = "Camera Error";
            sub.innerText = "Please enable camera permissions.";
        }
    }

    function analyzeLoop() {
        if (isProcessing) return;

        canvas.width = 320; 
        canvas.height = 240;
        ctx.drawImage(video, 0, 0, 320, 240);
        
        const pixels = ctx.getImageData(80, 60, 160, 120);
        const clarityScore = calculateClarity(pixels);
        
        // Update Meter
        bar.style.width = clarityScore + "%";
        
        if (clarityScore > 40) { // We see text
            guide.className = "detecting";
            status.innerText = "Text Detected. Holding Focus...";
            sub.innerText = `Clarity: ${Math.round(clarityScore)}% (Goal: 90%)`;
            
            // Auto-Flash if dim
            handleFlash(pixels);

            // Stability check: Is the clarity peaking?
            clarityHistory.push(clarityScore);
            if (clarityHistory.length > 15) clarityHistory.shift();

            const avgClarity = clarityHistory.reduce((a,b) => a+b, 0) / clarityHistory.length;
            
            // Trigger condition: High clarity + Stability
            if (clarityScore >= REQUIRED_CLARITY && clarityScore >= avgClarity) {
                lockAndCapture();
                return;
            }
        } else {
            guide.className = "";
            status.innerText = "Searching for List...";
            sub.innerText = "Move closer to the items";
            clarityHistory = [];
        }

        requestAnimationFrame(analyzeLoop);
    }

    function calculateClarity(imgData) {
        const d = imgData.data;
        let diff = 0;
        // Check vertical contrast (text lines)
        for (let i = 0; i < d.length - 4; i += 4) {
            diff += Math.abs(d[i] - d[i + 4]);
        }
        // Normalize to a 0-100 scale (approximate)
        let score = (diff / (imgData.width * imgData.height)) * 1.8;
        return Math.min(100, score);
    }

    async function handleFlash(imgData) {
        const d = imgData.data;
        let brightness = 0;
        for(let i=0; i<d.length; i+=40) brightness += (d[i]+d[i+1]+d[i+2])/3;
        brightness = brightness / (d.length/40);

        if (track && track.getCapabilities().torch) {
            if (brightness < 50) track.applyConstraints({advanced: [{torch: true}]});
            else if (brightness > 180) track.applyConstraints({advanced: [{torch: false}]});
        }
    }

    function lockAndCapture() {
        isProcessing = true;
        guide.className = "locked";
        status.innerText = "90% Clarity Achieved!";
        sub.innerText = "Focus Locked. Processing...";
        
        // Final Snap
        setTimeout(() => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const image = canvas.toDataURL('image/jpeg', 0.9);
            
            // Kill Camera
            stream.getTracks().forEach(t => t.stop());
            video.style.display = 'none';
            document.getElementById('results-screen').style.display = 'block';
            
            performOCR(image);
        }, 500); // 0.5s pause to ensure focus is perfect
    }

    async function performOCR(dataUrl) {
        const worker = await Tesseract.createWorker('eng');
        const { data: { text, confidence } } = await worker.recognize(dataUrl);
        await worker.terminate();

        document.getElementById('confidence-tag').innerText = `AI Confidence: ${confidence}%`;
        
        // Clean text: Filter for lines that look like products (contain words/numbers)
        const lines = text.split('\n')
            .filter(l => l.trim().length > 3)
            .map((l, i) => `${(i+1).toString().padStart(2,'0')} | ${l.trim()}`)
            .join('\n');

        document.getElementById('ocr-data').innerText = lines || "No items found. Try again.";
    }

    function copyResult() {
        const cleanText = document.getElementById('ocr-data').innerText.replace(/^\d+ \| /gm, '');
        navigator.clipboard.writeText(cleanText);
        alert("List Copied!");
    }

    window.onload = init;
</script>
</body>
</html>
