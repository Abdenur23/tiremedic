<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Receipt AI</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg: #0f172a;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            box-sizing: border-box;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Camera Viewfinder */
        #viewfinder-container {
            position: relative;
            width: 100%;
            aspect-ratio: 3/4;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.1);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .receipt-guide {
            width: 70%;
            height: 80%;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            position: relative;
            transition: border-color 0.3s;
        }

        .receipt-guide.active {
            border-color: #22c55e;
            box-shadow: 0 0 20px #22c55e;
        }

        /* Status Bar */
        #status-indicator {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            margin-top: -25px;
            z-index: 10;
            font-size: 0.9rem;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Results UI */
        #results-card {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .ocr-text {
            background: #000;
            color: #10b981;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: opacity 0.2s;
        }

        .btn:active { opacity: 0.8; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #334155;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }

        #progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <h1>SmartScan AI</h1>
        <p style="opacity: 0.7;">Align receipt within frame</p>
    </header>

    <div id="viewfinder-container">
        <video id="video" autoplay playsinline></video>
        <div class="overlay">
            <div id="guide" class="receipt-guide"></div>
        </div>
    </div>

    <div id="status-indicator">Initializing camera...</div>

    <div id="processing-ui" class="hidden">
        <p style="text-align: center;">Processing OCR...</p>
        <div class="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <div id="results-card">
        <h3>Extracted Content</h3>
        <div id="confidence-score" style="font-size: 0.8rem; margin-bottom: 5px;"></div>
        <div class="ocr-text" id="ocr-output"></div>
        <button class="btn" onclick="copyText()">Copy to Clipboard</button>
        <button class="btn" style="background: #334155;" onclick="resetApp()">Scan Another</button>
    </div>
</div>

<canvas id="analysis-canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const guide = document.getElementById('guide');
    const status = document.getElementById('status-indicator');
    const resultsCard = document.getElementById('results-card');
    const ocrOutput = document.getElementById('ocr-output');
    const analysisCanvas = document.getElementById('analysis-canvas');
    const progressFill = document.getElementById('progress-fill');
    
    let stream = null;
    let track = null;
    let isAnalyzing = true;
    let stabilityCounter = 0;
    const STABILITY_THRESHOLD = 15; // Frames of high quality needed

    // 1. Initialize Camera
    async function initCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            video.srcObject = stream;
            track = stream.getVideoTracks()[0];
            
            status.innerText = "Analyzing environment...";
            requestAnimationFrame(analyzeFrame);
        } catch (err) {
            status.innerText = "Camera Error: Please grant permissions.";
            console.error(err);
        }
    }

    // 2. Smart Detection Logic
    async function analyzeFrame() {
        if (!isAnalyzing) return;

        const ctx = analysisCanvas.getContext('2d');
        analysisCanvas.width = video.videoWidth / 4; // Downscale for speed
        analysisCanvas.height = video.videoHeight / 4;
        ctx.drawImage(video, 0, 0, analysisCanvas.width, analysisCanvas.height);

        const imageData = ctx.getImageData(0, 0, analysisCanvas.width, analysisCanvas.height);
        
        // A. Simple Brightness & Auto-Flash logic
        const brightness = getBrightness(imageData);
        handleFlash(brightness);

        // B. Sharpness Analysis (Laplacian Variance approximation)
        const sharpness = calculateSharpness(imageData);
        
        // C. Logic Gate
        if (sharpness > 25 && brightness > 40 && brightness < 220) {
            stabilityCounter++;
            guide.classList.add('active');
            status.innerText = "Hold Steady... Clear Scan Detected!";
            
            if (stabilityCounter >= STABILITY_THRESHOLD) {
                captureImage();
                return;
            }
        } else {
            stabilityCounter = 0;
            guide.classList.remove('active');
            status.innerText = sharpness < 25 ? "Focusing..." : "Adjusting Lighting...";
        }

        requestAnimationFrame(analyzeFrame);
    }

    function getBrightness(imageData) {
        let colorSum = 0;
        const data = imageData.data;
        for(let i = 0; i < data.length; i += 4) {
            colorSum += (data[i] + data[i+1] + data[i+2]) / 3;
        }
        return colorSum / (imageData.width * imageData.height);
    }

    function calculateSharpness(imageData) {
        // Simple edge intensity check as proxy for sharpness
        const data = imageData.data;
        const width = imageData.width;
        let score = 0;
        for (let i = 0; i < data.length - 4; i += 4) {
            const diff = Math.abs(data[i] - data[i+4]);
            score += diff;
        }
        return score / (data.length / 4);
    }

    async function handleFlash(brightness) {
        if (!track || !track.getCapabilities().torch) return;
        
        try {
            if (brightness < 50) {
                await track.applyConstraints({ advanced: [{ torch: true }] });
            } else if (brightness > 180) {
                await track.applyConstraints({ advanced: [{ torch: false }] });
            }
        } catch (e) { /* Torch not supported on all devices */ }
    }

    // 3. Capture and Stop Camera
    async function captureImage() {
        isAnalyzing = false;
        status.innerText = "Image Captured!";
        
        // Capture high-res frame
        analysisCanvas.width = video.videoWidth;
        analysisCanvas.height = video.videoHeight;
        analysisCanvas.getContext('2d').drawImage(video, 0, 0);
        const dataUrl = analysisCanvas.toDataURL('image/jpeg', 0.9);

        // Stop Camera
        track.stop();
        video.classList.add('hidden');
        document.getElementById('guide').classList.add('hidden');
        document.getElementById('processing-ui').classList.remove('hidden');

        processOCR(dataUrl);
    }

    // 4. OCR Processing
    async function processOCR(image) {
        try {
            const worker = await Tesseract.createWorker('eng', 1, {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        progressFill.style.width = `${m.progress * 100}%`;
                    }
                }
            });

            const { data: { text, confidence } } = await worker.recognize(image);
            await worker.terminate();

            displayResults(text, confidence);
        } catch (err) {
            status.innerText = "OCR Failed. Please try again.";
            console.error(err);
        }
    }

    function displayResults(text, confidence) {
        document.getElementById('processing-ui').classList.add('hidden');
        resultsCard.style.display = 'block';
        status.innerText = "Scan Complete";
        
        const lines = text.split('\n').map((line, i) => `${i+1} | ${line}`).join('\n');
        ocrOutput.innerText = lines || "No text detected.";
        document.getElementById('confidence-score').innerText = `AI Confidence: ${confidence}%`;
    }

    // Utils
    function copyText() {
        const text = ocrOutput.innerText.replace(/^\d+ \| /gm, '');
        navigator.clipboard.writeText(text);
        alert("Text copied!");
    }

    function resetApp() {
        location.reload(); // Simplest way to reset all states and re-init camera
    }

    window.onload = initCamera;
</script>

</body>
</html>
